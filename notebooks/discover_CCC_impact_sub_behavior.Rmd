---
title: "探索 CCC 对被试行为的影响"
output: html_notebook
---

## 0. 导入数据与包
```{r}
library(tidyverse)
library(here)
raw_data <- read_csv(here(
    "data", "input",
    "subdata_with_CCC_wang_2a1d1CCC.csv"
))
```

## 1. 标记不同的 conflict 特征

因为 conflict 在小于 threshold 与否上存在质性的行为差异, 而小于 0 与否则反映了被试当前的行为是否与过去积累的行为模式价值 Q 矩阵的模式相反. 因此探讨被试对于如上三种不同条件进行区分分析就存在意义.

```{r}
conflict_type <- rep(0, nrow(raw_data))
for (i in seq_len(nrow(raw_data))) {
    if (raw_data[i, ]$if_below_CCC) {
        conflict_type[i] <- 2
    } else if (!raw_data[i, ]$if_below_CCC & raw_data[i, ]$conflict < 0) {
        conflict_type[i] <- 1
    } else if (!raw_data[i, ]$if_below_CCC & raw_data[i, ]$conflict >= 0) {
        conflict_type[i] <- 0
    }
}
head(conflict_type)
add_conflict_type_data <- cbind(raw_data, conflict_type)
```

将上述的type放于Excel并标记颜色, 发现1与2分布并不均匀, 于是考虑可能是在被试间有区别(如不同的被试可能threshold不同)或条件间存在差异, 抑或是先做和后做的run会有所不同. 因此对1和2的比例进行考量.
```{r}
add_conflict_type_data %>%
    filter(conflict_type == 2) %>%
    group_by(Subject, condition) %>%
    summarise(prop_type_2 = n())
add_conflict_type_data %>%
    filter(conflict_type == 1) %>%
    group_by(Subject, condition) %>%
    summarise(prop_type_1 = n())
add_conflict_type_data %>%
    filter(conflict_type == 2) %>%
    group_by(Subject) %>%
    summarise(prop_type_2 = n())
add_conflict_type_data %>%
    filter(conflict_type == 1) %>%
    group_by(Subject) %>%
    summarise(prop_type_1 = n())
```

添加 block 信息, 选择每次更改比例就相当于新block的定义
```{r}
change_block_index <- function(input_dataframe) {
    prop_value <- input_dataframe$prop
    block_value <- rep(0, length(prop_value))
    block_index <- 1
    last_prop <- prop_value[1]
    for (i in seq_len(length(prop_value))) {
        if (last_prop != prop_value[i]) {
            block_index <- block_index + 1
            last_prop <- prop_value[i]
        }
        block_value[i] <- block_index
    }
    input_dataframe$nblock <- block_value
    return(input_dataframe)
}

add_nblock_list <- list()
for (i in seq_len(18)) {
    foo <- filter(add_conflict_type_data, Subject_num == i)
    add_nblock_list[[i]] <- change_block_index(foo)
}

add_nblock_table <- do.call(rbind, add_nblock_list)
```

按照每个被试的 nblock 信息再看一下分布模式
```{r}
add_nblock_table %>%
    filter(conflict_type == 2) %>%
    group_by(Subject, nblock) %>%
    summarise(prop_type_2 = n()) %>%
    ggplot() +
    geom_line(aes(x = nblock, y = prop_type_2, colour = Subject))

add_nblock_table %>%
    filter(conflict_type == 1) %>%
    group_by(Subject, nblock) %>%
    summarise(prop_type_1 = n()) %>%
    ggplot() +
    geom_line(aes(x = nblock, y = prop_type_1, colour = Subject))
```

这个模式就比较有意思了. 之后再来探讨.

接下来比较反应时的差异.

## 2. 不同条件下反应时模式

### 2.1 不同条件下的反应时差异

我们比较上一个 conflict type 为 0, 1, 2 时, 随后的 trial 其反应时有什么特征.

本质上, 反应时的变化应该能够体现 Q-Matrix 的变化. 在前一个 trial 为 conflict < threshold 时, 应该出现应用极大的 alpha 值进行更新, 因此会导致在之后刺激相同的 trial 应当快于其他两种 conflict type 后的 trial, 而刺激不同的 trial 应当慢于其他两种 conflict type 后的 trial. 让我们先把这不同类型的 trial 挑出来.

```{r}
# 变量命名规则: 在 conflict type 为 x 之后且刺激空间位置相同, 刺激颜色相同/不同的trial => cx_sloc_s/dcolor
c2_sloc_scolor_index <- c()
c2_sloc_dcolor_index <- c()
c1_sloc_scolor_index <- c()
c1_sloc_dcolor_index <- c()
c0_sloc_scolor_index <- c()
c0_sloc_dcolor_index <- c()

# 提取不同条件的index
for (idx in seq_len(nrow(add_nblock_table))) {
    if (idx == 1) {
        next
    }

    last_line <- add_nblock_table[idx - 1, ]
    current_line <- add_nblock_table[idx, ]

    if (last_line$conflict_type == 2) {
        if (last_line$stim_loc == current_line$stim_loc & last_line$stim_color == current_line$stim_color) {
            c2_sloc_scolor_index <- append(c2_sloc_scolor_index, idx)
        } else if (last_line$stim_loc == current_line$stim_loc & last_line$stim_color != current_line$stim_color) {
            c2_sloc_dcolor_index <- append(c2_sloc_dcolor_index, idx)
        }
    } else if (last_line$conflict_type == 1) {
        if (last_line$stim_loc == current_line$stim_loc & last_line$stim_color == current_line$stim_color) {
            c1_sloc_scolor_index <- append(c1_sloc_scolor_index, idx)
        } else if (last_line$stim_loc == current_line$stim_loc & last_line$stim_color != current_line$stim_color) {
            c1_sloc_dcolor_index <- append(c1_sloc_dcolor_index, idx)
        }
    } else if (last_line$conflict_type == 0) {
        if (last_line$stim_loc == current_line$stim_loc & last_line$stim_color == current_line$stim_color) {
            c0_sloc_scolor_index <- append(c0_sloc_scolor_index, idx)
        } else if (last_line$stim_loc == current_line$stim_loc & last_line$stim_color != current_line$stim_color) {
            c0_sloc_dcolor_index <- append(c0_sloc_dcolor_index, idx)
        }
    }
}
```
